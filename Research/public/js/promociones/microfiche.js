!function(){window.Microfiche=function(t){return this.initialize(t),this},Microfiche.VERSION="1.8.0",$.extend(Microfiche.prototype,{options:{autoplay:!1,autopause:!1,buttons:!0,bullets:!0,cyclic:!1,keyboard:!1,swipe:!0,clickToAdvance:!1,minDuration:250,duration:500,maxDuration:500,dragThreshold:10,elasticity:.5,swipeThreshold:.125,refreshOnResize:!1,prevButtonLabel:"&larr;",nextButtonLabel:"&rarr;",noScrollAlign:"left",easing:!1,width:$(window).width()},x:0,initialize:function(t){return this.options=$.extend({},this.options,t),this.el=$(t.el),this.initialContents=this.el.contents(),this.el.data("microfiche",this),this.createFilm(),this.createScreen(),this.calibrate(),this.film.width()<=this.screen.width()?(this.noScrollAlign(this.options.noScrollAlign),void this.refreshOnResize(this.options.refreshOnResize)):(this.createControls(),this.enableTouch(),this.enableKeyboard(),this.enableClick(),this.prepareCyclic(),void this.run(this.options))},createFilm:function(){this.film=$('<div class="microfiche-film">').css({position:"absolute"});this.el.find(".link-overlay img:eq(0)").height();this.el.children().appendTo(this.film).css({"float":"left",display:"inline-block"}),this.prepareFilm&&this.prepareFilm()},createScreen:function(){this.screen=$('<div class="microfiche-screen">').css({position:"relative",overflow:"hidden"}).appendTo(this.el).append(this.film)},prepareCyclic:function(){if(this.options.cyclic){var t=this.film.clone(),i=this.film.clone(),e=this.film.width();t.prependTo(this.film).css({position:"absolute",left:-e+"px"}),i.appendTo(this.film).css({position:"absolute",left:e+"px"})}},calibrate:function(){this.screen.width(1e5);var t=this.film.width(),i=this.film.height();this.film.width(t).height(i),this.screen.width("auto").height(i)},createControls:function(){var t=this;this.controls=$('<span class="microfiche-controls" />').appendTo(this.el),this.controls.on("click","a, button",function(i){t.didClickControl(i)}),this.options.bullets&&this.createBullets(),this.options.buttons&&this.createButtons(),this.updateControls()},createBullets:function(){for(var t=$('<span class="microfiche-bullets" />').appendTo(this.controls),i=0;i<this.totalPageCount();i++)$("<button>").addClass("microfiche-bullet").attr("data-microfiche-page",i).data("action","slideToPage").data("arguments",[i]).html(i+1).appendTo(t)},createButtons:function(){$("<button>").addClass("microfiche-button microfiche-prev-button").attr("rel","prev").data("action","prev").data("arguments",[]).html(this.options.prevButtonLabel).prependTo(this.controls),$("<button>").addClass("microfiche-button microfiche-next-button").attr("rel","next").data("action","next").data("arguments",[]).html(this.options.nextButtonLabel).appendTo(this.controls)},enableTouch:function(){if(this.options.swipe){var t=this,i=this.touchstart,e=this.touchmove,s=this.touchend;this.touchstart=function(){i.apply(t,arguments)},this.touchmove=function(){e.apply(t,arguments)},this.touchend=function(){s.apply(t,arguments)},this.film.on("touchstart",this.touchstart)}},enableKeyboard:function(){if(this.options.keyboard){var t=this;this.screen.attr("data-microfiche-keyboard",!0);var i=this.onkeydown;this.onkeydown=function(){i.apply(t,arguments)},$(document).on("keydown",this.onkeydown)}},enableClick:function(){if(this.options.clickToAdvance){var t=this,i=this.onmousedown;this.onmousedown=function(){i.apply(t,arguments)},this.film.on("mousedown",this.onmousedown)}},didClickControl:function(t){t.preventDefault();var i=$(t.target),e=i.data("action"),s=i.data("arguments");this[e].apply(this,s)},touchstart:function(t){var i=t.originalEvent.targetTouches;!i||i.length>1||(this.touchState={then:new Date,ox:i[0].pageX,oy:i[0].pageY,isDrag:!1},$(document).on("touchmove",this.touchmove).on("touchend",this.touchend))},touchmove:function(t){var i=t.originalEvent.targetTouches[0],e=i.pageX-this.touchState.ox,s=i.pageY-this.touchState.oy;if(!this.touchState.isDrag){if(Math.abs(s)>=this.options.dragThreshold)return void this.touchend();Math.abs(e)>=this.options.dragThreshold&&(this.touchState.isDrag=!0)}if(this.touchState.isDrag){t.preventDefault();var n=new Date,i=n-this.touchState.then;if(this.touchState.vx=(e-this.touchState.dx)/i,this.touchState.vy=(s-this.touchState.dy)/i,this.touchState.dx=e,this.touchState.dy=s,this.touchState.then=n,this.touchState.cx=this.x-e,!this.options.cyclic){if(this.touchState.cx<this.min()){var o=this.min()-this.touchState.cx;o*=this.options.elasticity,this.touchState.cx=this.min()-o}if(this.touchState.cx>this.max()){var o=this.touchState.cx-this.max();o*=this.options.elasticity,this.touchState.cx=this.max()+o}}this.film.css({WebkitTransition:"none",WebkitTransform:"translate3d("+-this.touchState.cx+"px, 0px, 0px)"})}},touchend:function(){if($(document).off("touchmove",this.touchmove).off("touchend",this.touchend),this.touchState.isDrag){var t=this.touchState.dx,i=this.screenWidth(),e=this.touchState.vx,s=this.options.swipeThreshold;-i*s>=t?this.slideByPages(1,e):t>=i*s?this.slideByPages(-1,e):this.slideByPages(0)}},onkeydown:function(t){37!==t.keyCode&&39!==t.keyCode||!this.isCentral("[data-microfiche-keyboard]")||(37===t.keyCode?this.slideByPages(-1):39===t.keyCode&&this.slideByPages(1))},onmousedown:function(){this.slideByPages(1)},updateControls:function(){this.options.bullets&&this.updateBullets(),this.options.buttons&&this.updateButtons()},updateBullets:function(){this.controls.find(".microfiche-bullet").removeClass("selected"),this.controls.find('[data-microfiche-page="'+this.currentPageIndex()+'"]').addClass("selected")},updateButtons:function(){this.options.cyclic||(this.controls.find('[rel="prev"]').attr("disabled",this.x<=this.min()),this.controls.find('[rel="next"]').attr("disabled",this.x>=this.max()))},round:function(t){var i=this.screenWidth();return Math.round(t/i)*i},constrain:function(t,i,e){return void 0===i&&(i=this.min()),void 0===e&&(e=this.max()),Math.max(i,Math.min(t,e))},roundAndConstrain:function(t,i,e){return this.constrain(this.round(t),i,e)},withinBounds:function(t){return this.min()<=t&&t<=this.max()},min:function(){return 0},max:function(){return this.film.width()-this.screenWidth()},currentPageIndex:function(){return Math.ceil(this.x/this.screenWidth())},totalPageCount:function(){return Math.ceil(this.film.width()/this.screenWidth())},screenWidth:function(){return this.el.width()},isCentral:function(t){var i=$($(t||".microfiche-screen").sort(function(t,i){return Math.abs(1-($(window).scrollTop()+$(window).height()/2-$(t).height()/2)/$(t).offset().top)-Math.abs(1-($(window).scrollTop()+$(window).height()/2-$(i).height()/2)/$(i).offset().top)})[0]).parent().data("microfiche");return i===this},jump:function(){this.el.trigger("microfiche:willMove"),this.performJump(),this.updateControls(),this.el.trigger("microfiche:didMove")},performJump:function(){this.film.css({left:-this.x})},transition:function(t){var i=this;this.options.cyclic&&this.handleWrappingTransition(),null==t&&(t=this.options.duration);var e=function(){i.afterTransition()};this.el.trigger("microfiche:willMove"),setTimeout(function(){i.performTransition(t,e)})},handleWrappingTransition:function(){this.x>this.max()?(this.x=this.min()-this.screenWidth(),this.touchState&&this.touchState.dx&&(this.x-=this.touchState.dx),this.jump(),this.x=this.min(),this.updateControls()):this.x<this.min()&&(this.x=this.max()+this.screenWidth(),this.touchState&&this.touchState.dx&&(this.x-=this.touchState.dx),this.jump(),this.x=this.max(),this.updateControls())},performTransition:function(t,i){this.film.stop().animate({left:-this.x+"px"},t,this.options.easing,i)},afterTransition:function(){delete this.touchState,this.el.trigger("microfiche:didMove")},slideByPages:function(t,i){var e=this.x,s=this.screenWidth();if(this.x=this.constrain((Math.round(this.x/s)+t)*s),this.options.cyclic&&this.x==e&&(this.x+=t*s),i)var n=this.constrain(Math.abs((this.x-e)/i),this.options.minDuration,this.options.maxDuration);else var n=this.options.duration;this.updateControls(),this.transition(n)},slideToPage:function(t){this.x=this.constrain(t*this.screenWidth()),this.updateControls(),this.transition()},slideToPoint:function(t){this.x=this.roundAndConstrain(t),this.updateControls(),this.transition()},jumpToPage:function(t){this.x=this.constrain(t*this.screenWidth()),this.updateControls(),this.jump()},jumpToPoint:function(t){this.x=this.roundAndConstrain(t),this.updateControls(),this.jump()},prev:function(){this.slideByPages(-1)},next:function(){this.slideByPages(1)},autoplay:function(t){if(this.autoplayTimeout&&(clearInterval(this.autoplayTimeout),delete this.autoplayTimeout),t=+t,!(isNaN(t)||0>=t)){var i=this;this.autoplayTimeout=setInterval(function(){i.pause||i.next()},1e3*t)}},autopause:function(){var t=this;this.el.hover(function(){t.pause=!0},function(){t.pause=!1})},destroy:function(){this.el.empty(),this.el.off(),this.clearResizeHandler(),this.el.removeData("microfiche")},refresh:function(){var t=this.el.data("microfiche").options,i=this.getContents();return this.destroy(),this.el.append(i),new Microfiche($.extend({el:this.el},t)),this.el},getContents:function(){return this.contentsChanged()?this.el.html():this.el.data("microfiche").initialContents},contentsChanged:function(){return 0===this.el.find(".microfiche-screen").length},refreshOnResize:function(t){if($(window).width()!=this.options.width){if(this.options.refreshOnResize=t,this.resizeHandler&&this.clearResizeHandler(),t===!1)return;t===!0&&(t=250);var i,e=this;e.resizeHandler=function(){i&&clearTimeout(i),i=setTimeout(function(){e.refresh()},t)},$(window).on("resize",e.resizeHandler),this.options.width=$(window).width()}},clearResizeHandler:function(){$(window).off("resize",this.resizeHandler)},noScrollAlign:function(t){if(!(this.film.width()>this.screen.width()))switch(t){case"center":this.film.css({left:"50%",marginLeft:this.film.width()/2*-1+"px",right:"auto"});break;case"right":this.film.css({left:"auto",marginLeft:"auto",right:0});break;default:this.film.css({left:0,marginLeft:"auto",right:"auto"})}},run:function(t){for(var i in t){var e=this[i];$.isFunction(e)&&e.call(this,t[i])}}}),"WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix&&$.extend(Microfiche.prototype,{prepareFilm:function(){this.film.css({WebkitTransform:"translate3d(0px, 0px, 0px)"})},performTransition:function(t,i){this.film.one("webkitTransitionEnd",i).css({WebkitTransition:"-webkit-transform "+t+"ms",WebkitTransform:"translate3d("+-this.x+"px, 0px, 0px)"})},performJump:function(){this.film.css({WebkitTransition:"-webkit-transform 0ms",WebkitTransform:"translate3d("+-this.x+"px, 0px, 0px)"})}}),jQuery.fn.microfiche=function(t){return this.each(function(){var i=$(this).data("microfiche");i?i.run(t):new Microfiche($.extend({el:this},t))})}}();
